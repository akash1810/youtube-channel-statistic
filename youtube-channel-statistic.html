<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="../core-image/core-image.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<link rel="import" href="../core-tooltip/core-tooltip.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/av-icons.html">
<link rel="import" href="../core-icons/communication-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-media-query/core-media-query.html">

<script src="../numeral/min/numeral.min.js"></script>
<script src="../moment/min/moment.min.js"></script>


<polymer-element name="youtube-channel-statistic" attributes="channelId apiKey">
  <template>
    <link rel="stylesheet" href="styles/youtube-channel-statistic.css">
    <core-media-query query="max-width: 640px" queryMatches="{{phoneScreen}}"></core-media-query>
    <paper-shadow z="1" id="outer-shadow">
      <div id="wrapper">
        <core-ajax auto
                   url="https://www.googleapis.com/youtube/v3/channels"
                   params='{"part": "statistics,snippet", "id": "{{channelId}}", "key": "{{apiKey}}"}'
                   handleAs="json"
                   on-core-response="{{handleYouTubeApiResponse}}"
                   on-core-error="{{handleYouTubeApiError}}">
        </core-ajax>

        <paper-shadow id="top-shadow" z="2">
          <div id="top" class="content">
            <div id="thumbnail">
              <paper-shadow z="1">
                <core-image src="{{thumbnail}}"></core-image>
              </paper-shadow>
            </div>

            <span>
              <div id="channelTitle">{{channelTitle}}</div>
              <div id="joinDate">since {{joinDate}}</div>
            </span>
          </div>
        </paper-shadow>

        <div id="bottom" class="content">
          <div id="channelId">
            <core-icon icon="account-circle" class="phone-{{phoneScreen}}"></core-icon>
            {{channelId}}
          </div>

          <template if="{{!phoneScreen}}">
            <div id="description">{{channelDescription}}</div>
          </template>

          <div layout vertical?="{{phoneScreen}}" horizontal?="{{!phoneScreen}}">
            <template repeat="{{stat in statistics}}">
              <div auto-vertical flex>
                <core-icon icon="{{stat.icon}}" class="phone-{{phoneScreen}}"></core-icon>
                <template if="{{phoneScreen}}">{{stat.value}} {{stat.name}}</template>
                <template if="{{!phoneScreen}}">{{stat.shortValue}}</template>
              </div>
            </template>
          </div>
        </div>

        <paper-fab mini id="openYouTube" icon="open-in-new" on-click="{{openYouTube}}"></paper-fab>
      </div>
    </paper-shadow>
  </template>

  <script>
    Polymer("youtube-channel-statistic", {
      channelId: "UC_x5XG1OV2P6uZZ5FSM9Ttw",
      apiKey: "",

      created: function () {
        this.statistics = [];

        this.iconMap = {
          viewCount: "visibility",
          commentCount: "communication:comment",
          subscriberCount: "social:people",
          videoCount: "av:movie"
        };
      },

      openYouTube: function () {
        window.open("//www.youtube.com/channel/" + this.channelId);
      },

      apiStatToHtml: function (key, value) {
        var name = key.replace('Count', 's');
        var htmlStatName = name.charAt(0).toUpperCase() + name.slice(1);

        return {
          id: key,
          name: htmlStatName,
          value: numeral(value).format("0,0"),
          shortValue: numeral(value).format("0a"),
          icon: this.iconMap[key]
        };
      },

      getStatistics: function (apiResponse) {
        var statistics = [];

        Object.keys(apiResponse).forEach(function (stat) {
          if (stat !== 'hiddenSubscriberCount') {
            statistics.push(this.apiStatToHtml(stat, apiResponse[stat]));
          }
        }.bind(this));

        return statistics;
      },

      handleYouTubeApiResponse: function (e) {
        var response = e.detail.response;

        if (response.items.length === 0) { return ; }

        var apiSnippet = response.items[0].snippet;

        this.channelTitle = apiSnippet.title;
        this.joinDate = moment(apiSnippet.publishedAt).format("DD MMMM YYYY");
        this.thumbnail = apiSnippet.thumbnails.default.url;
        this.channelDescription = apiSnippet.description;
        this.statistics = this.getStatistics(response.items[0].statistics);
      },

      handleYouTubeApiError: function (e) {
        console.log("=== ERROR ===");
        console.log(e);
      }
    });

  </script>

</polymer-element>
